var yr=Object.create;var kt=Object.defineProperty;var Dr=Object.getOwnPropertyDescriptor;var vr=Object.getOwnPropertyNames;var Pr=Object.getPrototypeOf,mr=Object.prototype.hasOwnProperty;var I=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var wr=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of vr(t))!mr.call(e,i)&&i!==r&&kt(e,i,{get:()=>t[i],enumerable:!(n=Dr(t,i))||n.enumerable});return e};var Z=(e,t,r)=>(r=e!=null?yr(Pr(e)):{},wr(t||!e||!e.__esModule?kt(r,"default",{value:e,enumerable:!0}):r,e));var Ie=I(g=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0});var Ur={withStackTrace:!1},Jt=(e,t,r=Ur)=>{let n=t.isOk()?{type:"Ok",value:t.value}:{type:"Err",value:t.error},i=r.withStackTrace?new Error().stack:void 0;return{data:n,message:e,stack:i}};function ut(e,t,r,n){function i(o){return o instanceof r?o:new r(function(a){a(o)})}return new(r||(r=Promise))(function(o,a){function l(f){try{h(n.next(f))}catch(c){a(c)}}function u(f){try{h(n.throw(f))}catch(c){a(c)}}function h(f){f.done?o(f.value):i(f.value).then(l,u)}h((n=n.apply(e,t||[])).next())})}function Wt(e){var t=typeof Symbol=="function"&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function te(e){return this instanceof te?(this.v=e,this):new te(e)}function kr(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=r.apply(e,t||[]),i,o=[];return i={},a("next"),a("throw"),a("return"),i[Symbol.asyncIterator]=function(){return this},i;function a(E){n[E]&&(i[E]=function(R){return new Promise(function(S,_){o.push([E,R,S,_])>1||l(E,R)})})}function l(E,R){try{u(n[E](R))}catch(S){c(o[0][3],S)}}function u(E){E.value instanceof te?Promise.resolve(E.value.v).then(h,f):c(o[0][2],E)}function h(E){l("next",E)}function f(E){l("throw",E)}function c(E,R){E(R),o.shift(),o.length&&l(o[0][0],o[0][1])}}function Mr(e){var t,r;return t={},n("next"),n("throw",function(i){throw i}),n("return"),t[Symbol.iterator]=function(){return this},t;function n(i,o){t[i]=e[i]?function(a){return(r=!r)?{value:te(e[i](a)),done:i==="return"}:o?o(a):a}:o}}function Fr(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator],r;return t?t.call(e):(e=typeof Wt=="function"?Wt(e):e[Symbol.iterator](),r={},n("next"),n("throw"),n("return"),r[Symbol.asyncIterator]=function(){return this},r);function n(o){r[o]=e[o]&&function(a){return new Promise(function(l,u){a=e[o](a),i(l,u,a.done,a.value)})}}function i(o,a,l,u){Promise.resolve(u).then(function(h){o({value:h,done:l})},a)}}var F=class e{constructor(t){this._promise=t}static fromSafePromise(t){let r=t.then(n=>new M(n));return new e(r)}static fromPromise(t,r){let n=t.then(i=>new M(i)).catch(i=>new Y(r(i)));return new e(n)}static combine(t){return Yr(t)}static combineWithAllErrors(t){return Gr(t)}map(t){return new e(this._promise.then(r=>ut(this,void 0,void 0,function*(){return r.isErr()?new Y(r.error):new M(yield t(r.value))})))}mapErr(t){return new e(this._promise.then(r=>ut(this,void 0,void 0,function*(){return r.isOk()?new M(r.value):new Y(yield t(r.error))})))}andThen(t){return new e(this._promise.then(r=>{if(r.isErr())return new Y(r.error);let n=t(r.value);return n instanceof e?n._promise:n}))}orElse(t){return new e(this._promise.then(r=>ut(this,void 0,void 0,function*(){return r.isErr()?t(r.error):new M(r.value)})))}match(t,r){return this._promise.then(n=>n.match(t,r))}unwrapOr(t){return this._promise.then(r=>r.unwrapOr(t))}safeUnwrap(){return kr(this,arguments,function*(){return yield te(yield te(yield*Mr(Fr(yield te(this._promise.then(r=>r.safeUnwrap()))))))})}then(t,r){return this._promise.then(t,r)}},qr=e=>new F(Promise.resolve(new M(e))),lt=e=>new F(Promise.resolve(new Y(e))),xr=F.fromPromise,$r=F.fromSafePromise,Hr=e=>t=>[...t,e],Kt=e=>e.reduce((t,r)=>t.isOk()?r.isErr()?H(r.error):t.map(Hr(r.value)):t,K([])),Yr=e=>F.fromSafePromise(Promise.all(e)).andThen(Kt),Vt=e=>e.reduce((t,r)=>r.isErr()?t.isErr()?H([...t.error,r.error]):H([r.error]):t.isErr()?t:K([...t.value,r.value]),K([])),Gr=e=>F.fromSafePromise(Promise.all(e)).andThen(Vt);g.Result=void 0;(function(e){function t(i,o){return(...a)=>{try{let l=i(...a);return K(l)}catch(l){return H(o?o(l):l)}}}e.fromThrowable=t;function r(i){return Kt(i)}e.combine=r;function n(i){return Vt(i)}e.combineWithAllErrors=n})(g.Result||(g.Result={}));var K=e=>new M(e),H=e=>new Y(e);function Qr(e){let t=e().next();return t instanceof Promise?t.then(r=>r.value):t.value}var M=class{constructor(t){this.value=t}isOk(){return!0}isErr(){return!this.isOk()}map(t){return K(t(this.value))}mapErr(t){return K(this.value)}andThen(t){return t(this.value)}orElse(t){return K(this.value)}asyncAndThen(t){return t(this.value)}asyncMap(t){return F.fromSafePromise(t(this.value))}unwrapOr(t){return this.value}match(t,r){return t(this.value)}safeUnwrap(){let t=this.value;return function*(){return t}()}_unsafeUnwrap(t){return this.value}_unsafeUnwrapErr(t){throw Jt("Called `_unsafeUnwrapErr` on an Ok",this,t)}},Y=class{constructor(t){this.error=t}isOk(){return!1}isErr(){return!this.isOk()}map(t){return H(this.error)}mapErr(t){return H(t(this.error))}andThen(t){return H(this.error)}orElse(t){return t(this.error)}asyncAndThen(t){return lt(this.error)}asyncMap(t){return lt(this.error)}unwrapOr(t){return t}match(t,r){return r(this.error)}safeUnwrap(){let t=this.error;return function*(){throw yield H(t),new Error("Do not use this generator out of `safeTry`")}()}_unsafeUnwrap(t){throw Jt("Called `_unsafeUnwrap` on an Err",this,t)}_unsafeUnwrapErr(t){return this.error}},jr=g.Result.fromThrowable;g.Err=Y;g.Ok=M;g.ResultAsync=F;g.err=H;g.errAsync=lt;g.fromPromise=xr;g.fromSafePromise=$r;g.fromThrowable=jr;g.ok=K;g.okAsync=qr;g.safeTry=Qr});var P=I(Se=>{"use strict";Object.defineProperty(Se,"__esModule",{value:!0});Se.RethinkDBErrorType=void 0;var Wr;(function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.API_FAIL=1]="API_FAIL",e[e.CONNECTION=2]="CONNECTION",e[e.MASTER_POOL_FAIL=3]="MASTER_POOL_FAIL",e[e.POOL_FAIL=4]="POOL_FAIL",e[e.CURSOR_END=5]="CURSOR_END",e[e.TIMEOUT=6]="TIMEOUT",e[e.CANCEL=7]="CANCEL",e[e.PARSE=8]="PARSE",e[e.ARITY=9]="ARITY",e[e.CURSOR=10]="CURSOR",e[e.AUTH=11]="AUTH",e[e.UNSUPPORTED_PROTOCOL=12]="UNSUPPORTED_PROTOCOL",e[e.INTERNAL=13]="INTERNAL",e[e.RESOURCE_LIMIT=14]="RESOURCE_LIMIT",e[e.QUERY_LOGIC=15]="QUERY_LOGIC",e[e.NON_EXISTENCE=16]="NON_EXISTENCE",e[e.OP_FAILED=17]="OP_FAILED",e[e.OP_INDETERMINATE=18]="OP_INDETERMINATE",e[e.USER=19]="USER",e[e.PERMISSION_ERROR=20]="PERMISSION_ERROR"})(Wr=Se.RethinkDBErrorType||(Se.RethinkDBErrorType={}))});var B=I(d=>{"use strict";Object.defineProperty(d,"__esModule",{value:!0});d.TermType=d.DatumType=d.ResponseNote=d.ErrorType=d.ResponseType=d.FrameType=d.QueryType=d.Protocol=d.Version=void 0;var Jr;(function(e){e[e.V0_1=1063369270]="V0_1",e[e.V0_2=1915781601]="V0_2",e[e.V0_3=1601562686]="V0_3",e[e.V0_4=1074539808]="V0_4",e[e.V1_0=885177795]="V1_0"})(Jr=d.Version||(d.Version={}));var Kr;(function(e){e[e.PROTOBUF=656407617]="PROTOBUF",e[e.JSON=2120839367]="JSON"})(Kr=d.Protocol||(d.Protocol={}));var Vr;(function(e){e[e.START=1]="START",e[e.CONTINUE=2]="CONTINUE",e[e.STOP=3]="STOP",e[e.NOREPLY_WAIT=4]="NOREPLY_WAIT",e[e.SERVER_INFO=5]="SERVER_INFO"})(Vr=d.QueryType||(d.QueryType={}));var zr;(function(e){e[e.POS=1]="POS",e[e.OPT=2]="OPT"})(zr=d.FrameType||(d.FrameType={}));var Xr;(function(e){e[e.SUCCESS_ATOM=1]="SUCCESS_ATOM",e[e.SUCCESS_SEQUENCE=2]="SUCCESS_SEQUENCE",e[e.SUCCESS_PARTIAL=3]="SUCCESS_PARTIAL",e[e.WAIT_COMPLETE=4]="WAIT_COMPLETE",e[e.SERVER_INFO=5]="SERVER_INFO",e[e.CLIENT_ERROR=16]="CLIENT_ERROR",e[e.COMPILE_ERROR=17]="COMPILE_ERROR",e[e.RUNTIME_ERROR=18]="RUNTIME_ERROR"})(Xr=d.ResponseType||(d.ResponseType={}));var Zr;(function(e){e[e.INTERNAL=1e6]="INTERNAL",e[e.RESOURCE_LIMIT=2e6]="RESOURCE_LIMIT",e[e.QUERY_LOGIC=3e6]="QUERY_LOGIC",e[e.NON_EXISTENCE=31e5]="NON_EXISTENCE",e[e.OP_FAILED=41e5]="OP_FAILED",e[e.OP_INDETERMINATE=42e5]="OP_INDETERMINATE",e[e.USER=5e6]="USER",e[e.PERMISSION_ERROR=6e6]="PERMISSION_ERROR"})(Zr=d.ErrorType||(d.ErrorType={}));var en;(function(e){e[e.SEQUENCE_FEED=1]="SEQUENCE_FEED",e[e.ATOM_FEED=2]="ATOM_FEED",e[e.ORDER_BY_LIMIT_FEED=3]="ORDER_BY_LIMIT_FEED",e[e.UNIONED_FEED=4]="UNIONED_FEED",e[e.INCLUDES_STATES=5]="INCLUDES_STATES"})(en=d.ResponseNote||(d.ResponseNote={}));var tn;(function(e){e[e.R_NULL=1]="R_NULL",e[e.R_BOOL=2]="R_BOOL",e[e.R_NUM=3]="R_NUM",e[e.R_STR=4]="R_STR",e[e.R_ARRAY=5]="R_ARRAY",e[e.R_OBJECT=6]="R_OBJECT",e[e.R_JSON=7]="R_JSON"})(tn=d.DatumType||(d.DatumType={}));var rn;(function(e){e[e.DATUM=1]="DATUM",e[e.MAKE_ARRAY=2]="MAKE_ARRAY",e[e.MAKE_OBJ=3]="MAKE_OBJ",e[e.VAR=10]="VAR",e[e.JAVASCRIPT=11]="JAVASCRIPT",e[e.UUID=169]="UUID",e[e.HTTP=153]="HTTP",e[e.ERROR=12]="ERROR",e[e.IMPLICIT_VAR=13]="IMPLICIT_VAR",e[e.DB=14]="DB",e[e.TABLE=15]="TABLE",e[e.GET=16]="GET",e[e.GET_ALL=78]="GET_ALL",e[e.EQ=17]="EQ",e[e.NE=18]="NE",e[e.LT=19]="LT",e[e.LE=20]="LE",e[e.GT=21]="GT",e[e.GE=22]="GE",e[e.NOT=23]="NOT",e[e.ADD=24]="ADD",e[e.SUB=25]="SUB",e[e.MUL=26]="MUL",e[e.DIV=27]="DIV",e[e.MOD=28]="MOD",e[e.FLOOR=183]="FLOOR",e[e.CEIL=184]="CEIL",e[e.ROUND=185]="ROUND",e[e.APPEND=29]="APPEND",e[e.PREPEND=80]="PREPEND",e[e.DIFFERENCE=95]="DIFFERENCE",e[e.SET_INSERT=88]="SET_INSERT",e[e.SET_INTERSECTION=89]="SET_INTERSECTION",e[e.SET_UNION=90]="SET_UNION",e[e.SET_DIFFERENCE=91]="SET_DIFFERENCE",e[e.SLICE=30]="SLICE",e[e.SKIP=70]="SKIP",e[e.LIMIT=71]="LIMIT",e[e.OFFSETS_OF=87]="OFFSETS_OF",e[e.CONTAINS=93]="CONTAINS",e[e.GET_FIELD=31]="GET_FIELD",e[e.KEYS=94]="KEYS",e[e.VALUES=186]="VALUES",e[e.OBJECT=143]="OBJECT",e[e.HAS_FIELDS=32]="HAS_FIELDS",e[e.WITH_FIELDS=96]="WITH_FIELDS",e[e.PLUCK=33]="PLUCK",e[e.WITHOUT=34]="WITHOUT",e[e.MERGE=35]="MERGE",e[e.BETWEEN_DEPRECATED=36]="BETWEEN_DEPRECATED",e[e.BETWEEN=182]="BETWEEN",e[e.REDUCE=37]="REDUCE",e[e.MAP=38]="MAP",e[e.FOLD=187]="FOLD",e[e.FILTER=39]="FILTER",e[e.CONCAT_MAP=40]="CONCAT_MAP",e[e.ORDER_BY=41]="ORDER_BY",e[e.DISTINCT=42]="DISTINCT",e[e.COUNT=43]="COUNT",e[e.IS_EMPTY=86]="IS_EMPTY",e[e.UNION=44]="UNION",e[e.NTH=45]="NTH",e[e.BRACKET=170]="BRACKET",e[e.INNER_JOIN=48]="INNER_JOIN",e[e.OUTER_JOIN=49]="OUTER_JOIN",e[e.EQ_JOIN=50]="EQ_JOIN",e[e.ZIP=72]="ZIP",e[e.RANGE=173]="RANGE",e[e.INSERT_AT=82]="INSERT_AT",e[e.DELETE_AT=83]="DELETE_AT",e[e.CHANGE_AT=84]="CHANGE_AT",e[e.SPLICE_AT=85]="SPLICE_AT",e[e.COERCE_TO=51]="COERCE_TO",e[e.TYPE_OF=52]="TYPE_OF",e[e.UPDATE=53]="UPDATE",e[e.DELETE=54]="DELETE",e[e.REPLACE=55]="REPLACE",e[e.INSERT=56]="INSERT",e[e.DB_CREATE=57]="DB_CREATE",e[e.DB_DROP=58]="DB_DROP",e[e.DB_LIST=59]="DB_LIST",e[e.TABLE_CREATE=60]="TABLE_CREATE",e[e.TABLE_DROP=61]="TABLE_DROP",e[e.TABLE_LIST=62]="TABLE_LIST",e[e.CONFIG=174]="CONFIG",e[e.STATUS=175]="STATUS",e[e.WAIT=177]="WAIT",e[e.RECONFIGURE=176]="RECONFIGURE",e[e.REBALANCE=179]="REBALANCE",e[e.SYNC=138]="SYNC",e[e.GRANT=188]="GRANT",e[e.INDEX_CREATE=75]="INDEX_CREATE",e[e.INDEX_DROP=76]="INDEX_DROP",e[e.INDEX_LIST=77]="INDEX_LIST",e[e.INDEX_STATUS=139]="INDEX_STATUS",e[e.INDEX_WAIT=140]="INDEX_WAIT",e[e.INDEX_RENAME=156]="INDEX_RENAME",e[e.SET_WRITE_HOOK=189]="SET_WRITE_HOOK",e[e.GET_WRITE_HOOK=190]="GET_WRITE_HOOK",e[e.FUNCALL=64]="FUNCALL",e[e.BRANCH=65]="BRANCH",e[e.OR=66]="OR",e[e.AND=67]="AND",e[e.FOR_EACH=68]="FOR_EACH",e[e.FUNC=69]="FUNC",e[e.ASC=73]="ASC",e[e.DESC=74]="DESC",e[e.INFO=79]="INFO",e[e.MATCH=97]="MATCH",e[e.UPCASE=141]="UPCASE",e[e.DOWNCASE=142]="DOWNCASE",e[e.SAMPLE=81]="SAMPLE",e[e.DEFAULT=92]="DEFAULT",e[e.JSON=98]="JSON",e[e.ISO8601=99]="ISO8601",e[e.TO_ISO8601=100]="TO_ISO8601",e[e.EPOCH_TIME=101]="EPOCH_TIME",e[e.TO_EPOCH_TIME=102]="TO_EPOCH_TIME",e[e.NOW=103]="NOW",e[e.IN_TIMEZONE=104]="IN_TIMEZONE",e[e.DURING=105]="DURING",e[e.DATE=106]="DATE",e[e.TIME_OF_DAY=126]="TIME_OF_DAY",e[e.TIMEZONE=127]="TIMEZONE",e[e.YEAR=128]="YEAR",e[e.MONTH=129]="MONTH",e[e.DAY=130]="DAY",e[e.DAY_OF_WEEK=131]="DAY_OF_WEEK",e[e.DAY_OF_YEAR=132]="DAY_OF_YEAR",e[e.HOURS=133]="HOURS",e[e.MINUTES=134]="MINUTES",e[e.SECONDS=135]="SECONDS",e[e.TIME=136]="TIME",e[e.MONDAY=107]="MONDAY",e[e.TUESDAY=108]="TUESDAY",e[e.WEDNESDAY=109]="WEDNESDAY",e[e.THURSDAY=110]="THURSDAY",e[e.FRIDAY=111]="FRIDAY",e[e.SATURDAY=112]="SATURDAY",e[e.SUNDAY=113]="SUNDAY",e[e.JANUARY=114]="JANUARY",e[e.FEBRUARY=115]="FEBRUARY",e[e.MARCH=116]="MARCH",e[e.APRIL=117]="APRIL",e[e.MAY=118]="MAY",e[e.JUNE=119]="JUNE",e[e.JULY=120]="JULY",e[e.AUGUST=121]="AUGUST",e[e.SEPTEMBER=122]="SEPTEMBER",e[e.OCTOBER=123]="OCTOBER",e[e.NOVEMBER=124]="NOVEMBER",e[e.DECEMBER=125]="DECEMBER",e[e.LITERAL=137]="LITERAL",e[e.GROUP=144]="GROUP",e[e.SUM=145]="SUM",e[e.AVG=146]="AVG",e[e.MIN=147]="MIN",e[e.MAX=148]="MAX",e[e.SPLIT=149]="SPLIT",e[e.UNGROUP=150]="UNGROUP",e[e.RANDOM=151]="RANDOM",e[e.CHANGES=152]="CHANGES",e[e.ARGS=154]="ARGS",e[e.BINARY=155]="BINARY",e[e.GEOJSON=157]="GEOJSON",e[e.TO_GEOJSON=158]="TO_GEOJSON",e[e.POINT=159]="POINT",e[e.LINE=160]="LINE",e[e.POLYGON=161]="POLYGON",e[e.DISTANCE=162]="DISTANCE",e[e.INTERSECTS=163]="INTERSECTS",e[e.INCLUDES=164]="INCLUDES",e[e.CIRCLE=165]="CIRCLE",e[e.GET_INTERSECTING=166]="GET_INTERSECTING",e[e.FILL=167]="FILL",e[e.GET_NEAREST=168]="GET_NEAREST",e[e.POLYGON_SUB=171]="POLYGON_SUB",e[e.TO_JSON_STRING=172]="TO_JSON_STRING",e[e.MINVAL=180]="MINVAL",e[e.MAXVAL=181]="MAXVAL",e[e.BIT_AND=191]="BIT_AND",e[e.BIT_OR=192]="BIT_OR",e[e.BIT_XOR=193]="BIT_XOR",e[e.BIT_NOT=194]="BIT_NOT",e[e.BIT_SAL=195]="BIT_SAL",e[e.BIT_SAR=196]="BIT_SAR"})(rn=d.TermType||(d.TermType={}))});var ie=I(Pe=>{"use strict";Object.defineProperty(Pe,"__esModule",{value:!0});Pe.globals=void 0;Pe.globals={nextVarId:1,nestingLevel:20,arrayLimit:void 0,pretty:!0,backtraceType:"lambda"}});var ht=I(me=>{"use strict";Object.defineProperty(me,"__esModule",{value:!0});me.hasImplicitVar=void 0;var nn=B();function ct(e){if(!Array.isArray(e))return e!==null&&typeof e=="object"?Object.values(e).some(r=>ct(r)):!1;if(e[0]===nn.TermType.IMPLICIT_VAR)return!0;let t=e[1];return t?t.some(r=>ct(r)):!1}me.hasImplicitVar=ct});var we=I(U=>{"use strict";Object.defineProperty(U,"__esModule",{value:!0});U.rConsts=U.rConfig=U.termConfig=U.funcall=U.bracket=void 0;var s=B();U.bracket=[s.TermType.BRACKET,"(...)",1,1,!1];U.funcall=[s.TermType.FUNCALL,"do",1,-1,!1];U.termConfig=[[s.TermType.TABLE,"table",1,2,"last"],[s.TermType.GET,"get",1,1,!1],[s.TermType.GET_ALL,"getAll",0,-1,"optional"],[s.TermType.EQ,"eq",1,-1,!1],[s.TermType.NE,"ne",1,-1,!1],[s.TermType.LT,"lt",1,-1,!1],[s.TermType.LE,"le",1,-1,!1],[s.TermType.GT,"gt",1,-1,!1],[s.TermType.GE,"ge",1,-1,!1],[s.TermType.NOT,"not",0,0,!1],[s.TermType.ADD,"add",1,-1,!1],[s.TermType.SUB,"sub",1,-1,!1],[s.TermType.MUL,"mul",1,-1,!1],[s.TermType.DIV,"div",1,-1,!1],[s.TermType.MOD,"mod",1,1,!1],[s.TermType.FLOOR,"floor",0,0,!1],[s.TermType.CEIL,"ceil",0,0,!1],[s.TermType.ROUND,"round",0,-1,!1],[s.TermType.APPEND,"append",1,1,!1],[s.TermType.PREPEND,"prepend",1,1,!1],[s.TermType.DIFFERENCE,"difference",1,1,!1],[s.TermType.SET_INSERT,"setInsert",1,1,!1],[s.TermType.SET_INTERSECTION,"setIntersection",1,1,!1],[s.TermType.SET_UNION,"setUnion",1,1,!1],[s.TermType.SET_DIFFERENCE,"setDifference",1,1,!1],[s.TermType.SLICE,"slice",1,3,"last-optional"],[s.TermType.SKIP,"skip",1,1,!1],[s.TermType.LIMIT,"limit",1,1,!1],[s.TermType.OFFSETS_OF,"offsetsOf",1,1,!1],[s.TermType.CONTAINS,"contains",1,-1,!1],[s.TermType.GET_FIELD,"getField",1,1,!1],[s.TermType.KEYS,"keys",0,0,!1],[s.TermType.VALUES,"values",0,0,!1],[s.TermType.HAS_FIELDS,"hasFields",1,-1,!1],[s.TermType.WITH_FIELDS,"withFields",1,-1,!1],[s.TermType.PLUCK,"pluck",1,-1,!1],[s.TermType.WITHOUT,"without",1,-1,!1],[s.TermType.MERGE,"merge",1,-1,!1],[s.TermType.BETWEEN,"between",2,3,"last"],[s.TermType.REDUCE,"reduce",1,1,!1],[s.TermType.MAP,"map",1,-1,!1],[s.TermType.FOLD,"fold",2,3,"last"],[s.TermType.FILTER,"filter",1,2,"last"],[s.TermType.CONCAT_MAP,"concatMap",1,1,!1],[s.TermType.ORDER_BY,"orderBy",1,-1,"optional"],[s.TermType.DISTINCT,"distinct",0,1,"last"],[s.TermType.COUNT,"count",0,1,!1],[s.TermType.IS_EMPTY,"isEmpty",0,0,!1],[s.TermType.UNION,"union",0,-1,"optional"],[s.TermType.NTH,"nth",1,1,!1],[s.TermType.INNER_JOIN,"innerJoin",2,2,!1],[s.TermType.OUTER_JOIN,"outerJoin",2,2,!1],[s.TermType.EQ_JOIN,"eqJoin",2,3,"last"],[s.TermType.ZIP,"zip",0,0,!1],[s.TermType.INSERT_AT,"insertAt",2,2,!1],[s.TermType.DELETE_AT,"deleteAt",1,2,!1],[s.TermType.CHANGE_AT,"changeAt",2,2,!1],[s.TermType.SPLICE_AT,"spliceAt",2,2,!1],[s.TermType.COERCE_TO,"coerceTo",1,1,!1],[s.TermType.TYPE_OF,"typeOf",0,0,!1],[s.TermType.UPDATE,"update",1,2,"last"],[s.TermType.DELETE,"delete",0,1,"last"],[s.TermType.REPLACE,"replace",1,2,"last"],[s.TermType.INSERT,"insert",1,2,"last"],[s.TermType.TABLE_CREATE,"tableCreate",1,2,"last"],[s.TermType.TABLE_DROP,"tableDrop",1,1,!1],[s.TermType.TABLE_LIST,"tableList",0,0,!1],[s.TermType.CONFIG,"config",0,0,!1],[s.TermType.STATUS,"status",0,0,!1],[s.TermType.WAIT,"wait",0,1,"last"],[s.TermType.RECONFIGURE,"reconfigure",1,1,"required"],[s.TermType.REBALANCE,"rebalance",0,0,!1],[s.TermType.SYNC,"sync",0,0,!1],[s.TermType.GRANT,"grant",2,2,!1],[s.TermType.INDEX_CREATE,"indexCreate",1,3,"last-optional"],[s.TermType.INDEX_DROP,"indexDrop",1,1,!1],[s.TermType.INDEX_LIST,"indexList",0,0,!1],[s.TermType.INDEX_STATUS,"indexStatus",0,-1,!1],[s.TermType.INDEX_WAIT,"indexWait",0,-1,!1],[s.TermType.INDEX_RENAME,"indexRename",2,3,"last"],[s.TermType.BRANCH,"branch",2,-1,!1],[s.TermType.OR,"or",0,-1,!1],[s.TermType.AND,"and",0,-1,!1],[s.TermType.FOR_EACH,"forEach",1,1,!1],[s.TermType.INFO,"info",0,0,!1],[s.TermType.MATCH,"match",1,1,!1],[s.TermType.UPCASE,"upcase",0,0,!1],[s.TermType.DOWNCASE,"downcase",0,0,!1],[s.TermType.SAMPLE,"sample",1,1,!1],[s.TermType.DEFAULT,"default",1,1,!1],[s.TermType.TO_ISO8601,"toISO8601",0,0,!1],[s.TermType.TO_EPOCH_TIME,"toEpochTime",0,0,!1],[s.TermType.IN_TIMEZONE,"inTimezone",1,1,!1],[s.TermType.DURING,"during",2,3,"last"],[s.TermType.DATE,"date",0,0,!1],[s.TermType.TIME_OF_DAY,"timeOfDay",0,0,!1],[s.TermType.TIMEZONE,"timezone",0,0,!1],[s.TermType.YEAR,"year",0,0,!1],[s.TermType.MONTH,"month",0,0,!1],[s.TermType.DAY,"day",0,0,!1],[s.TermType.DAY_OF_WEEK,"dayOfWeek",0,0,!1],[s.TermType.DAY_OF_YEAR,"dayOfYear",0,0,!1],[s.TermType.HOURS,"hours",0,0,!1],[s.TermType.MINUTES,"minutes",0,0,!1],[s.TermType.SECONDS,"seconds",0,0,!1],[s.TermType.GROUP,"group",0,-1,"optional"],[s.TermType.SUM,"sum",0,1,!1],[s.TermType.AVG,"avg",0,1,!1],[s.TermType.MIN,"min",0,1,"optional"],[s.TermType.MAX,"max",0,1,"optional"],[s.TermType.SPLIT,"split",0,2,!1],[s.TermType.UNGROUP,"ungroup",0,0,!1],[s.TermType.CHANGES,"changes",0,1,"last"],[s.TermType.TO_GEOJSON,"toGeojson",0,0,!1],[s.TermType.DISTANCE,"distance",1,2,"last"],[s.TermType.INTERSECTS,"intersects",1,1,!1],[s.TermType.INCLUDES,"includes",1,1,!1],[s.TermType.GET_INTERSECTING,"getIntersecting",2,2,"required"],[s.TermType.FILL,"fill",0,0,!1],[s.TermType.GET_NEAREST,"getNearest",2,2,"required"],[s.TermType.POLYGON_SUB,"polygonSub",1,1,!1],[s.TermType.TO_JSON_STRING,"toJSON",0,0,!1],[s.TermType.TO_JSON_STRING,"toJsonString",0,0,!1],[s.TermType.SET_WRITE_HOOK,"setWriteHook",1,1,!1],[s.TermType.GET_WRITE_HOOK,"getWriteHook",0,0,!1],[s.TermType.BIT_AND,"bitAnd",1,-1,!1],[s.TermType.BIT_OR,"bitOr",1,-1,!1],[s.TermType.BIT_XOR,"bitXor",1,-1,!1],[s.TermType.BIT_NOT,"bitNot",0,0,!1],[s.TermType.BIT_SAL,"bitSal",1,-1,!1],[s.TermType.BIT_SAL,"bitShl",1,-1,!1],[s.TermType.BIT_SAR,"bitSar",1,-1,!1],[197,"bitShr",1,-1,!1]];U.rConfig=[[s.TermType.ASC,"asc",1,1,!1],[s.TermType.DESC,"desc",1,1,!1],[s.TermType.EPOCH_TIME,"epochTime",1,1,!1],[s.TermType.NOW,"now",0,0,!1],[s.TermType.TIME,"time",4,7,!1],[s.TermType.ISO8601,"ISO8601",1,2,"last"],[s.TermType.BINARY,"binary",1,1,!1],[s.TermType.JSON,"json",1,1,!1],[s.TermType.OBJECT,"object",1,-1,!1],[s.TermType.POINT,"point",2,2,!1],[s.TermType.LINE,"line",2,-1,!1],[s.TermType.POLYGON,"polygon",3,-1,!1],[s.TermType.CIRCLE,"circle",2,3,"last"],[s.TermType.GEOJSON,"geojson",1,1,!1],[s.TermType.ARGS,"args",1,1,!1],[s.TermType.ERROR,"error",0,1,!1],[s.TermType.JAVASCRIPT,"js",1,2,"last"],[s.TermType.LITERAL,"literal",0,1,!1],[s.TermType.RANDOM,"random",0,3,"last-optional"],[s.TermType.RANGE,"range",1,2,!1],[s.TermType.UUID,"uuid",0,1,!1],[s.TermType.HTTP,"http",1,2,"last"],[s.TermType.GRANT,"grant",2,2,!1],[s.TermType.DB,"db",1,1,!1],[s.TermType.DB_CREATE,"dbCreate",1,1,!1],[s.TermType.DB_DROP,"dbDrop",1,1,!1],[s.TermType.DB_LIST,"dbList",0,0,!1],[s.TermType.TABLE,"table",1,2,"last"],[s.TermType.TABLE_CREATE,"tableCreate",1,2,"last"],[s.TermType.TABLE_DROP,"tableDrop",1,1,!1],[s.TermType.TABLE_LIST,"tableList",0,0,!1]];U.rConsts=[[s.TermType.IMPLICIT_VAR,"row"],[s.TermType.MINVAL,"minval"],[s.TermType.MAXVAL,"maxval"],[s.TermType.MONDAY,"monday"],[s.TermType.TUESDAY,"tuesday"],[s.TermType.WEDNESDAY,"wednesday"],[s.TermType.THURSDAY,"thursday"],[s.TermType.FRIDAY,"friday"],[s.TermType.SATURDAY,"saturday"],[s.TermType.SUNDAY,"sunday"],[s.TermType.JANUARY,"january"],[s.TermType.FEBRUARY,"february"],[s.TermType.MARCH,"march"],[s.TermType.APRIL,"april"],[s.TermType.MAY,"may"],[s.TermType.JUNE,"june"],[s.TermType.JULY,"july"],[s.TermType.AUGUST,"august"],[s.TermType.SEPTEMBER,"september"],[s.TermType.OCTOBER,"october"],[s.TermType.NOVEMBER,"november"],[s.TermType.DECEMBER,"december"]]});var G=I(p=>{"use strict";Object.defineProperty(p,"__esModule",{value:!0});p.snakeToCamel=p.isPromise=p.isObject=p.isNativeError=p.isFunction=p.isDate=p.delay=p.camelToSnake=void 0;var sn=e=>typeof e=="function";p.isFunction=sn;var zt=e=>Object.prototype.toString.call(e),ft=e=>e!==null&&typeof e=="object";p.isObject=ft;function on(e,t){return new Promise(r=>{let n=setTimeout(r,e);t&&t.unref&&n.unref()})}p.delay=on;function an(e){return e.replace(/(_[a-z])/g,t=>t.charAt(1).toUpperCase())}p.snakeToCamel=an;function un(e){return e.replace(/([A-Z])/g,t=>`_${t.toLowerCase()}`)}p.camelToSnake=un;var ln=e=>ft(e)&&zt(e)==="[object Date]";p.isDate=ln;var cn=e=>ft(e)&&(zt(e)==="[object Error]"||e instanceof Error);p.isNativeError=cn;function hn(e){return e!==null&&typeof e=="object"&&typeof e.then=="function"}p.isPromise=hn});var dt=I(Le=>{"use strict";Object.defineProperty(Le,"__esModule",{value:!0});Le.backtraceTerm=void 0;var se=B(),fn=ie(),En=ht(),Et=we(),dn=G();function pe(e,t){if(t&&t[0]===e)return t.slice(1)}function V(e,t){return e[0]?[`${e[0]}, ${t[0]}`,`${e[1]}  ${t[1]}`]:[t[0],t[1]]}function O(e,t){let r=Array.isArray(e)?e[0]:e,n=Array.isArray(e)?e[1]:" ".repeat(e.length);return t&&t.length===0?[r,"^".repeat(r.length)]:[r,n]}function N(e,...t){let r="",n="";for(let i=0;i<t.length;i++)r+=e[i],n+=" ".repeat(e[i].length),Array.isArray(t[i])?(r+=t[i][0],n+=t[i][1]):(r+=t[i],n+=" ".repeat(t[i].length));return r+=e[e.length-1],n+=" ".repeat(e[e.length-1].length),[r,n]}function be(e,t){let[r,...n]=t||[];return e.$reql_type$==="BINARY"?O("<Buffer>",t):Object.keys(e).length===0?O("{}",t):N`{ ${Object.entries(e).map(([i,o])=>{let a=r===i?n:void 0;return O(N`${(0,dn.snakeToCamel)(i)}: ${ge(o,!1,a)}`)}).reduce(V,["",""])} }`}function ge(e,t=!0,r){let n=(u,h,f,c=!1)=>ge(u,c||!f&&h===0,pe(h,r));if(e===void 0)return O("");if(!Array.isArray(e)){let u=["",""];return e===null?u=O("null"):typeof e=="object"?u=be(e,r):typeof e=="string"?u=O(`"${e}"`):u=O(e.toString()),O(t?N`r.expr(${u})`:u,r)}let[i,o,a]=e,l=!!o&&!!o.length;switch(i){case se.TermType.MAKE_ARRAY:return o?O(t?N`r.expr([${o.map(n).reduce(V,["",""])}])`:N`[${o.map(n).reduce(V,["",""])}]`,r):O("");case se.TermType.IMPLICIT_VAR:return O("r.row",r);case se.TermType.FUNC:{if(o&&Array.isArray(o)&&(0,En.hasImplicitVar)(e))return ge(o[1],!1,pe(1,r));let u=pe(0,r),f=o[0][1].map(E=>O(`var_${E}`,pe(E,u))).reduce(V,["",""]),c=ge(o[1],!1,pe(1,r));return O(fn.globals.backtraceType==="lambda"?N`(${f}) => ${c}`:N`function(${f}) { return ${c} }`,r)}case se.TermType.VAR:return O(`var_${o[0]}`,r);case se.TermType.FUNCALL:{if(!o)return O("");let[u,h,...f]=o,c=f.map((S,_)=>n(S,_+2)).reduce(V,["",""]),E=n(u,0),R=n(h,1,void 0,!0);return O(c[0]?N`${R}.do(${c}, ${E})`:N`${R}.do(${E})`,r)}case se.TermType.BRACKET:{if(!o)return O("");let[u,...h]=o,f=[...h].map((c,E)=>n(c,E+1)).reduce(V,["",""]);return O(N`${n(u,0)}(${f})`,r)}default:{let u=Et.rConsts.find(T=>T[0]===i);if(u)return O(`r.${u[1]}`,r);let h=Et.termConfig.find(T=>T[0]===i);if(!h){let T=Et.rConfig.find(W=>W[0]===i);if(T){let W=[...o||[]].map(n).reduce(V,["",""]);if(a){let De=be(a,r);return O(l?N`r.${T[1]}(${W}, ${De})`:N`r.${T[1]}(${De})`,r)}return O(N`r.${T[1]}(${W})`,r)}return O("")}if(!o)return O(N`r.${h[1]}(${be(a,r)})`,r);let[f,...c]=o,E=c.length>0,R=c.map((T,W)=>n(T,W+1)).reduce(V,["",""]),S=n(f,0),_=a?be(a,r):void 0;return O(_?E?N`${S}.${h[1]}(${R}, ${_})`:N`${S}.${h[1]}(${_})`:N`${S}.${h[1]}(${R})`,r)}}}Le.backtraceTerm=ge});var m=I(oe=>{"use strict";Object.defineProperty(oe,"__esModule",{value:!0});oe.isRethinkDBError=oe.RethinkDBError=void 0;var k=P(),z=B(),_n=ie(),Rn=dt();function On(e,t){let r="",n=0,i=[],o="",a=!0,l=!1,u=!1,h=0,f=0,c="",E="",R=!1,S=[];for(let _=0;_<e.length;_+=1)switch(o=e.charAt(_),l||(["{","(","["].includes(o)?S.unshift(o):(o==="}"&&S[0]==="{"||o===")"&&S[0]==="("||o==="]"&&S[0]==="[")&&S.shift()),o){case".":u=!1,a=!1,l||r.length-h<=80+n?r+=o:(R||(n+=4),c+=t.substring(f,_),f=_+1,r=r.trimRight(),E=c.charAt(r.length-h)||t.charAt(_),c=c.substring(0,r.length-h),r+=c.includes("^")?`
${c}
${" ".repeat(n)}.`:`
${" ".repeat(n)}.`,h=r.length-n-1,c=" ".repeat(n)+E,R=!0);break;case",":l||S[0]!=="{"?(a=!1,r+=o):(a=!0,c+=t.substring(f,_+1),f=_+1,r+=c.includes("^")?`,
${c}
${" ".repeat(n)}`:`,
${" ".repeat(n)}`,h=r.length-n,c=" ".repeat(n));break;case"{":u=!1,l||e.charAt(_+1)==="}"?(a=!1,r+=o):(a=!0,i.push(n),R=!1,n+=4,c+=t.substring(f,_+1),f=_+1,r+=c.includes("^")?`{
${c}
${" ".repeat(n)}`:`{
${" ".repeat(n)}`,h=r.length-n,c=" ".repeat(n));break;case"}":a=!1,u=!1,l||e.charAt(_-1)==="{"?r+=o:(n=i.pop()||0,c+=t.substring(f,_),f=_+1,r=r.trimRight(),E=c.charAt(r.length-h)||t.charAt(_),c=c.substring(0,r.length-h),r+=c.includes("^")?`
${c}
${" ".repeat(n)}}`:`
${" ".repeat(n)}}`,h=r.length-n-1,c=" ".repeat(n)+E);break;case" ":u=!1,a?f+=1:r+=o;break;case'"':u?u=!1:l=!l,a=!1,r+=o;break;case"\\":u=!escape,a=!1,r+=o;break;default:u=!1,a=!1,r+=o;break}return c+=t.substring(f,e.length),r=r.trimRight(),c=c.substring(0,r.length-h),r+=c.includes("^")?`
${c}
`:`
`,r}function An(e){return e.charAt(e.length-1)===":"?e:e.charAt(e.length-1)==="."?`${e.substring(0,e.length-1)} in:`:`${e} in:`}function In(e,t,r){let n=e,i=t;if(i){n=An(n);let[o,a]=(0,Rn.backtraceTerm)(i,!0,r);_n.globals.pretty?n+=`
${On(o,a)}`:(n+=`
${o}
`,r&&(n+=`${a}
`))}return n}function Sn({errorCode:e,type:t,responseErrorType:r}){if(t)return{name:"ReqlDriverError",type:t};if(e&&e>=10&&e<=20)return{name:"ReqlAuthError",type:k.RethinkDBErrorType.AUTH};switch(r){case z.ErrorType.INTERNAL:return{name:"ReqlInternalError",type:k.RethinkDBErrorType.INTERNAL};case z.ErrorType.NON_EXISTENCE:return{name:"ReqlNonExistanceError",type:k.RethinkDBErrorType.NON_EXISTENCE};case z.ErrorType.OP_FAILED:return{name:"ReqlOpFailedError",type:k.RethinkDBErrorType.OP_FAILED};case z.ErrorType.OP_INDETERMINATE:return{name:"ReqlOpIndeterminateError",type:k.RethinkDBErrorType.OP_INDETERMINATE};case z.ErrorType.PERMISSION_ERROR:return{name:"ReqlPermissionError",type:k.RethinkDBErrorType.PERMISSION_ERROR};case z.ErrorType.QUERY_LOGIC:return{name:"ReqlLogicError",type:k.RethinkDBErrorType.QUERY_LOGIC};case z.ErrorType.RESOURCE_LIMIT:return{name:"ReqlResourceError",type:k.RethinkDBErrorType.RESOURCE_LIMIT};case z.ErrorType.USER:return{name:"ReqlUserError",type:k.RethinkDBErrorType.USER};default:return{name:"ReqlUnknownError",type:k.RethinkDBErrorType.UNKNOWN}}}var Te=class e extends Error{constructor(t,r={}){let{cause:n,type:i,term:o,errorCode:a,backtrace:l,responseErrorType:u}=r;super(In(t,o,l)),this.msg=t,this.type=k.RethinkDBErrorType.UNKNOWN,this.cause=n,this.name="ReqlDriverError",this.msg=t,this.term=o;let{name:h,type:f}=Sn({errorCode:a,responseErrorType:u,type:i});this.name=h,this.type=f,Error.captureStackTrace(this,e)}};oe.RethinkDBError=Te;function pn(e){return e instanceof Te}oe.isRethinkDBError=pn});var ke=I(q=>{"use strict";Object.defineProperty(q,"__esModule",{value:!0});q.termBuilder=q.isQuery=q.querySymbol=void 0;var Be=P(),Ue=m(),gn=B(),Xt=Me(),Zt=_t();q.querySymbol=Symbol("RethinkDBQuery");var Nn=e=>e===Object(e)&&Object.hasOwnProperty.call(e,q.querySymbol);q.isQuery=Nn;var er=["","First","Second","Third","Fourth","Fifth"];function Cn(e){return er.map((t,r)=>r).includes(e)?er[e]:e.toString()}function yn([e,t,r,n,i],o,a){return(...l)=>{let u,h=a!==void 0?[a]:[];if((0,q.isQuery)(l[0])&&l[0].term[0]===gn.TermType.ARGS)h.push((0,Xt.parseParam)(l[0])),u=i!==!1?l[1]:void 0;else{let c=l.length;if(r===n&&c!==r)throw new Ue.RethinkDBError(`\`${a?t:`r.${t}`}\` takes ${r} argument${r===1?"":"s"}, ${c} provided${a?" after:":"."}`,{term:a,type:Be.RethinkDBErrorType.ARITY});if(c<r)throw new Ue.RethinkDBError(`\`${a?t:`r.${t}`}\` takes at least ${r} argument${r===1?"":"s"}, ${c} provided${a?" after:":"."}`,{term:a,type:Be.RethinkDBErrorType.ARITY});if(n!==-1&&c>n)throw new Ue.RethinkDBError(`\`${a?t:`r.${t}`}\` takes at most ${n} argument${n===1?"":"s"}, ${c} provided${a?" after:":"."}`,{term:a,type:Be.RethinkDBErrorType.ARITY});switch(i){case"last":u=(0,Zt.parseOptarg)(l[n-1]);break;case"required":case"optional":case"last-optional":u=(0,Zt.parseOptarg)(l[c-1])}if(!u&&(i==="required"||c===n&&["last","last-optional"].includes(i)))throw new Ue.RethinkDBError(`${Cn(c)} argument of \`${t}\` must be an object.`,{term:a,type:Be.RethinkDBErrorType.ARITY});h.push(...l.filter((E,R)=>u?R<c-1:!0).map(E=>(0,Xt.parseParam)(E)))}let f=[e];return h.length>0&&(f[1]=h),u&&(f[2]=u),o(f)}}q.termBuilder=yn});var Rt=I(He=>{"use strict";Object.defineProperty(He,"__esModule",{value:!0});He.toQuery=void 0;var Fe=we(),xe=Ye(),tr=P(),rr=Ge(),nr=m(),Dn=dt(),qe=ke(),vn=e=>(...t)=>{let r=t.pop(),n=(0,qe.termBuilder)(Fe.funcall,$e);return r?n(r,e,...t):n(e)},Pn=e=>async(t,r)=>{let n=t instanceof xe.RethinkDBConnection?t:void 0,i=rr.r.getPoolMaster(),o=t instanceof xe.RethinkDBConnection?r:t;if(!n&&(!i||i.draining))throw new nr.RethinkDBError("`run` was called without a connection and no pool has been created after:",{term:e,type:tr.RethinkDBErrorType.API_FAIL});let a=n?await n.query(e,o):await i.queue(e,o);if(a){let l=await a.resolve();if(l)switch(a.getType()){case"Atom":return a.profile?{profile:a.profile,result:l[0]}:l[0];case"Cursor":return a.profile?{profile:a.profile,result:await a.toArray()}:a.toArray();default:return a}}},mn=e=>async(t,r)=>{let n=t instanceof xe.RethinkDBConnection?t:void 0,i=rr.r.getPoolMaster(),o=t instanceof xe.RethinkDBConnection?r:t;if(!n&&(!i||i.draining))throw new nr.RethinkDBError("`getCursor` was called without a connection and no pool has been created after:",{term:e,type:tr.RethinkDBErrorType.API_FAIL});let a=n?await n.query(e,o):await i.queue(e,o);if(a)return a.init(),a};function $e(e){let t=(0,qe.termBuilder)(Fe.bracket,$e,e);t.term=e,t[qe.querySymbol]=!0,t.toString=()=>(0,Dn.backtraceTerm)(e)[0],t.run=Pn(e),t.getCursor=mn(e),t.do=vn(t);for(let r=0;r<Fe.termConfig.length;r+=1){let n=Fe.termConfig[r];t[n[1]]=(0,qe.termBuilder)(n,$e,e)}return t}He.toQuery=$e});var Me=I(Je=>{"use strict";Object.defineProperty(Je,"__esModule",{value:!0});Je.parseParam=void 0;var Qe=P(),je=m(),x=B(),ae=ie(),wn=ke(),bn=Rt(),ir=G(),Ot=ht();function We(e,t=ae.globals.nestingLevel){if(t===0)throw new je.RethinkDBError(`Nesting depth limit exceeded.
You probably have a circular reference somewhere.`,{type:Qe.RethinkDBErrorType.PARSE});if(e===null)return null;if((0,wn.isQuery)(e)){if(e.term===void 0)throw new je.RethinkDBError("'r' cannot be an argument",{type:Qe.RethinkDBErrorType.PARSE});return ae.globals.nextVarId===1&&t===ae.globals.nestingLevel&&(0,Ot.hasImplicitVar)(e.term)?[x.TermType.FUNC,[[x.TermType.MAKE_ARRAY,[1]],e.term]]:e.term}if(Array.isArray(e)){let r=[x.TermType.MAKE_ARRAY,e.map(n=>We(n,t-1))];return(0,Ot.hasImplicitVar)(r)?[x.TermType.FUNC,[[x.TermType.MAKE_ARRAY,[1]],r]]:r}if((0,ir.isDate)(e))return{$reql_type$:"TIME",epoch_time:e.getTime()/1e3,timezone:"+00:00"};if(Buffer.isBuffer(e))return{$reql_type$:"BINARY",data:e.toString("base64")};if((0,ir.isFunction)(e)){let{nextVarId:r}=ae.globals;ae.globals.nextVarId=r+e.length;try{let n=e(...Array.from({length:e.length},(i,o)=>(0,bn.toQuery)([x.TermType.VAR,[o+r]])));if(n===void 0)throw new je.RethinkDBError(`Anonymous function returned \`undefined\`. Did you forget a \`return\`? in:
${e.toString()}`,{type:Qe.RethinkDBErrorType.PARSE});return[x.TermType.FUNC,[[x.TermType.MAKE_ARRAY,Array.from({length:e.length},(i,o)=>o+r)],We(n)]]}finally{ae.globals.nextVarId=r}}if(typeof e=="object"){let r=Object.entries(e).reduce((n,[i,o])=>(n[i]=We(o,t-1),n),{});return(0,Ot.hasImplicitVar)(r)?[x.TermType.FUNC,[[x.TermType.MAKE_ARRAY,[1]],r]]:r}if(typeof e=="number"&&(Number.isNaN(e)||!Number.isFinite(e)))throw new je.RethinkDBError(`Cannot convert \`${e}\` to JSON`,{type:Qe.RethinkDBErrorType.PARSE});return e}Je.parseParam=We});var _t=I(Ke=>{"use strict";Object.defineProperty(Ke,"__esModule",{value:!0});Ke.parseOptarg=void 0;var sr=G(),Ln=Me();function Tn(e){if(!(!(0,sr.isObject)(e)||Array.isArray(e)))return Object.entries(e).reduce((t,[r,n])=>(t[(0,sr.camelToSnake)(r)]=(0,Ln.parseParam)(n),t),{})}Ke.parseOptarg=Tn});var or=I(Ve=>{"use strict";Object.defineProperty(Ve,"__esModule",{value:!0});Ve.getNativeTypes=void 0;var Bn=P(),Un=m();function Ne(e,{binaryFormat:t="native",groupFormat:r="native",timeFormat:n="native"}={}){if(Array.isArray(e))return e.map(i=>Ne(i,{binaryFormat:t,groupFormat:r,timeFormat:n}));if(e===null||typeof e!="object")return e;if(e.$reql_type$)switch(e.$reql_type$){case"TIME":if(n==="native")return new Date(e.epoch_time*1e3);if(n==="ISO8601"){let{epoch_time:i,timezone:o}=e,[a,l]=o.split(":").map(h=>parseInt(h,10)),u=(i+a*60*60+Math.sign(a)*l*60)*1e3;return new Date(u).toISOString().replace("Z",o)}break;case"BINARY":if(t==="native")return Buffer.from(e.data,"base64");break;case"GROUPED_DATA":if(r==="native")return e.data.map(([i,o])=>({group:Ne(i,{binaryFormat:t,groupFormat:r,timeFormat:n}),reduction:Ne(o,{binaryFormat:t,groupFormat:r,timeFormat:n})}));break;case"GEOMETRY":break;default:throw new Un.RethinkDBError("Unexpected value of $reql_type",{type:Bn.RethinkDBErrorType.PARSE})}return Object.entries(e).reduce((i,[o,a])=>(i[o]=Ne(a),i),{})}Ve.getNativeTypes=Ne});var At=I(ue=>{"use strict";Object.defineProperty(ue,"__esModule",{value:!0});ue.isCursor=ue.Cursor=void 0;var kn=require("stream"),D=m(),b=B(),C=P(),Mn=G(),Fn=or(),ze=class extends kn.Readable{constructor(t,r,n,i){super({objectMode:!0}),this.conn=t,this.token=r,this.runOptions=n,this.query=i,this.position=0,this.type="Cursor",this.includeStates=!1,this._closed=!1,this.emitting=!1}get profile(){return this._profile}init(){this.resolving=this.resolve().catch(t=>{this.lastError=t})}_read(){this.emitting=!0;let t=r=>{r===null?this._next().then(t):this.push(r)};this._next().then(t).catch(r=>{(!(0,D.isRethinkDBError)(r)||![C.RethinkDBErrorType.CURSOR_END,C.RethinkDBErrorType.CANCEL].includes(r.type))&&this.listenerCount("error")>0&&this.emit("error",r),this.push(null)})}pause(){return this.emitting=!1,super.pause()}resume(){return this._read(),super.resume()}destroy(t){return super.destroy(t)}_destroy(){this.close()}toString(){return`[object ${this.type}]`}getType(){return this.type}async close(){this._closed||(this.conn.status==="open"&&this.conn.stopQuery(this.token),this.emitting=!1,this._closed=!0)}async next(){if(this.emitting)throw new D.RethinkDBError("You cannot call `next` once you have bound listeners on the Feed.",{type:C.RethinkDBErrorType.CURSOR});if(this._closed)throw new D.RethinkDBError(`You cannot call \`next\` on a closed ${this.type}`,{type:C.RethinkDBErrorType.CURSOR});return this._next()}async toArray(){if(this.emitting)throw new D.RethinkDBError("You cannot call `toArray` once you have bound listeners on the Feed.",{type:C.RethinkDBErrorType.CURSOR});let t=[];return this.eachAsync(async r=>{if(this.type.endsWith("Feed"))throw new D.RethinkDBError("You cannot call `toArray` on a change Feed.",{type:C.RethinkDBErrorType.CURSOR});t.push(r)}).then(()=>t)}async each(t,r){if(this.emitting)throw new D.RethinkDBError("You cannot call `each` once you have bound listeners on the Feed.",{type:C.RethinkDBErrorType.CURSOR});if(this._closed){t(new D.RethinkDBError("You cannot retrieve data from a cursor that is closed",{type:C.RethinkDBErrorType.CURSOR})),r&&r();return}let n=!0,i,o;for(;n!==!1&&!this._closed;){i=void 0;try{o=await this.next()}catch(a){i=a}if(i&&i.type===C.RethinkDBErrorType.CURSOR_END)break;n=t(i,o)}r&&r()}async eachAsync(t,r){if(this.emitting)throw new D.RethinkDBError("You cannot call `eachAsync` once you have bound listeners on the Feed.",{type:C.RethinkDBErrorType.CURSOR});if(this._closed)throw new D.RethinkDBError("You cannot retrieve data from a cursor that is closed",{type:C.RethinkDBErrorType.CURSOR});let n;try{for(;!this._closed;)if(n=await this.next(),t.length>1)await new Promise((i,o)=>{t(n,a=>a?o(new D.RethinkDBError(a,{type:C.RethinkDBErrorType.USER})):i())});else{let i=t(n);if(i!==void 0&&!(0,Mn.isPromise)(i))throw i;await i}}catch(i){if(r)try{await r(i);return}catch(o){i=o}if(!(0,D.isRethinkDBError)(i)||![C.RethinkDBErrorType.CURSOR_END,C.RethinkDBErrorType.CANCEL].includes(i.type))throw i}}async resolve(){try{let t=await this.conn.readNext(this.token),{n:r,t:n,r:i,p:o}=t;return this._profile=o,this.position=0,this.results=(0,Fn.getNativeTypes)(i,this.runOptions),this.handleResponseNotes(n,r),this.handleErrors(t),this.hasNextBatch=n===b.ResponseType.SUCCESS_PARTIAL,this.results}catch(t){throw this.emitting=!1,this._closed=!0,this.results=void 0,this.hasNextBatch=!1,t}}[Symbol.asyncIterator](){return{next:async()=>{if(this._closed)return{done:!0,value:void 0};try{return{value:await this.next(),done:!1}}catch(t){if((0,D.isRethinkDBError)(t)&&[C.RethinkDBErrorType.CANCEL,C.RethinkDBErrorType.CURSOR_END].some(r=>r===t.type))return{done:!0,value:void 0};throw t}}}}async _next(){if(this.lastError)throw this.emitting=!1,this._closed=!0,this.results=void 0,this.hasNextBatch=!1,this.lastError;try{this.resolving&&(await this.resolving,this.resolving=void 0);let t=this.getResults(),r=t&&t[this.position];for(;r===void 0&&this.hasNextBatch;)this.resolving||(this.resolving=this.resolve(),this.conn.continueQuery(this.token)),await this.resolving,this.resolving=void 0,t=this.getResults(),r=t&&t[this.position];if(!this.hasNextBatch&&r===void 0)throw new D.RethinkDBError("No more rows in the cursor.",{type:C.RethinkDBErrorType.CURSOR_END});return this.position+=1,r}catch(t){throw this._closed=!0,t}}getResults(){return this.results&&this.type==="Atom"&&Array.isArray(this.results[0])?this.results[0]:this.results}handleErrors(t){let{t:r,b:n,r:i,e:o}=t;switch(r){case b.ResponseType.CLIENT_ERROR:case b.ResponseType.COMPILE_ERROR:case b.ResponseType.RUNTIME_ERROR:throw new D.RethinkDBError(i[0],{responseErrorType:o,responseType:r,term:this.query[1],backtrace:n});case b.ResponseType.SUCCESS_ATOM:case b.ResponseType.SUCCESS_PARTIAL:case b.ResponseType.SUCCESS_SEQUENCE:break;default:throw new D.RethinkDBError("Unexpected return value")}}handleResponseNotes(t,r=[]){if(t===b.ResponseType.SUCCESS_ATOM){this.includeStates=!1,this.type="Atom";return}let{type:n,includeStates:i}=r.reduce((o,a)=>{switch(a){case b.ResponseNote.SEQUENCE_FEED:o.type="Feed";break;case b.ResponseNote.ATOM_FEED:o.type="AtomFeed";break;case b.ResponseNote.ORDER_BY_LIMIT_FEED:o.type="OrderByLimitFeed";break;case b.ResponseNote.UNIONED_FEED:o.type="UnionedFeed";break;case b.ResponseNote.INCLUDES_STATES:o.includeStates=!0}return o},{type:"Cursor",includeStates:!0});this.type=n,this.includeStates=i}};ue.Cursor=ze;function qn(e){return e instanceof ze}ue.isCursor=qn});var ar=I(Xe=>{"use strict";Object.defineProperty(Xe,"__esModule",{value:!0});Xe.DataQueue=void 0;var It=class{constructor(){this.queue=[],this.waiting=[]}enqueue(t,r){if(this.waiting.length>0){let n=this.waiting.shift();n&&(r&&r(),n.resolve(t))}else this.queue.push({data:t,op:r})}destroy(t){let r=this.waiting.shift();for(;r;)r.resolve(t),r=this.waiting.shift()}async dequeue(){if(this.queue.length>0){let{data:n=null,op:i=null}=this.queue.shift()||{};if(i&&i(),n)return n}let t,r=new Promise(n=>{let i=this.waiting.length;t=o=>{this.waiting.splice(i,1),n(o)}});return this.waiting.push({resolve:t,promise:r}),r}};Xe.DataQueue=It});var ur=I(w=>{"use strict";Object.defineProperty(w,"__esModule",{value:!0});w.compareDigest=w.computeSaltedPassword=w.validateVersion=w.buildAuthBuffer=w.NULL_BUFFER=void 0;var re=require("crypto"),xn=require("util"),gt=P(),Nt=m(),$n=B();w.NULL_BUFFER=Buffer.from("\0","binary");var pt=0,Hn="SCRAM-SHA-256",Yn=32,St={},Gn=(0,xn.promisify)(re.pbkdf2);function Qn(e,t){let r=[],n=Math.min(e.length,t.length);for(let i=0;i<n;i+=1)r.push(e[i]^t[i]);return Buffer.from(r)}function jn(e){let t=Buffer.alloc(4);t.writeInt32LE($n.Version.V1_0,0);let r=(0,re.randomBytes)(18).toString("base64"),n=Buffer.from(JSON.stringify({protocol_version:pt,authentication_method:Hn,authentication:`n,,n=${e},r=${r}`}));return{authBuffer:Buffer.concat([t,n,w.NULL_BUFFER]),randomString:r}}w.buildAuthBuffer=jn;function Wn(e){if(e.max_protocol_version<pt||e.min_protocol_version>pt)throw new Nt.RethinkDBError("Unsupported protocol version",{type:gt.RethinkDBErrorType.UNSUPPORTED_PROTOCOL})}w.validateVersion=Wn;async function Jn(e,t,r){let n=`${e.toString("base64")},${t.toString("base64")},${r}`;return St[n]||(St[n]=await Gn(e,t,r,Yn,"sha256")),St[n]}async function Kn(e,t,r,n){let[i,o,a]=e.split(",").map(De=>De.substring(2)),l=Buffer.from(o,"base64");if(i.substring(0,t.length)!==t)throw new Nt.RethinkDBError("Invalid nonce from server",{type:gt.RethinkDBErrorType.AUTH});let u=await Jn(n,l,Number.parseInt(a,10)),h=`c=biws,r=${i}`,f=(0,re.createHmac)("sha256",u).update("Client Key").digest(),c=(0,re.createHash)("sha256").update(f).digest(),E=`n=${r},r=${t},${e},${h}`,R=(0,re.createHmac)("sha256",c).update(E).digest(),S=(0,re.createHmac)("sha256",u).update("Server Key").digest(),_=(0,re.createHmac)("sha256",S).update(E).digest().toString("base64"),T=Qn(f,R).toString("base64"),W=`${h},p=${T}`;return{serverSignature:_,proof:Buffer.concat([Buffer.from(JSON.stringify({authentication:W})),w.NULL_BUFFER])}}w.computeSaltedPassword=Kn;function Vn(e,t){if(e.substring(e.indexOf("=")+1)!==t)throw new Nt.RethinkDBError("Invalid server signature",{type:gt.RethinkDBErrorType.AUTH})}w.compareDigest=Vn});var Ze=I(le=>{"use strict";Object.defineProperty(le,"__esModule",{value:!0});le.RethinkDBSocket=le.setConnectionDefaults=void 0;var zn=require("events"),Xn=require("net"),Zn=require("tls"),Q=P(),$=m(),Ce=B(),lr=ar(),ye=ur(),ei=G();function cr(e){return Object.assign(Object.assign({},e),{host:e.host||"localhost",port:e.port||28015})}le.setConnectionDefaults=cr;var Ct=class extends zn.EventEmitter{constructor({connectionOptions:t,user:r="admin",password:n=""}){super(),this.runningQueries=new Map,this.isOpen=!1,this.nextToken=0,this.buffer=Buffer.alloc(0),this.mode="handshake",this.connectionOptions=cr(t),this.user=r,this.password=n?Buffer.from(n):ye.NULL_BUFFER}get status(){return this.lastError?"errored":this.isOpen?this.mode==="handshake"?"handshake":"open":"closed"}async connect(){if(this.socket)throw new $.RethinkDBError("Socket already connected",{type:Q.RethinkDBErrorType.CONNECTION});let t=this.connectionOptions;try{let r=await new Promise((n,i)=>{if(t.tls){let o=(0,Zn.connect)(t);o.once("secureConnect",()=>{o.authorized||t.rejectUnauthorized===!1?n(o):(i(o.authorizationError),o.destroy())}),o.once("error",i)}else{let o=(0,Xn.connect)(t);o.once("connect",()=>n(o)),o.once("error",i)}});r.removeAllListeners(),r.on("close",()=>this.close()).on("end",()=>this.close()).on("error",n=>this.handleError(n)).on("data",n=>{try{switch(this.buffer=Buffer.concat([this.buffer,n]),this.mode){case"handshake":this.handleHandshakeData();break;case"response":this.handleData();break;default:break}}catch(i){this.handleError(i)}}),r.setKeepAlive(!0),this.socket=r,this.isOpen=!0,this.lastError=void 0,await this.performHandshake(),this.emit("connect")}catch(r){this.handleError(r)}}sendQuery(t,r){if(!this.socket||this.status!=="open")throw new $.RethinkDBError("`run` was called with a closed connection after:",{term:t[1],type:Q.RethinkDBErrorType.CONNECTION});r===void 0&&(r=this.nextToken++);let n=JSON.stringify(t),i=Buffer.byteLength(n),o=Buffer.alloc(12+i);o.writeUInt32LE(r&4294967295,0),o.writeUInt32LE(Math.floor(r/4294967295),4),o.writeUInt32LE(i,8),o.write(n,12);let{noreply:a=!1}=t[2]||{};if(a)return this.socket.write(o),this.emit("query",r),r;let[l]=t,{query:u=t,data:h=null}=this.runningQueries.get(r)||{};return l===Ce.QueryType.STOP?(this.socket.write(o),h&&(h.destroy(new $.RethinkDBError("Query cancelled",{term:u[1],type:Q.RethinkDBErrorType.CANCEL})),this.runningQueries.delete(r),this.emit("release",this.runningQueries.size)),r):(h||this.runningQueries.set(r,{data:new lr.DataQueue,query:u}),this.socket.write(o),this.emit("query",r),r)}stopQuery(t){this.runningQueries.has(t)&&this.sendQuery([Ce.QueryType.STOP],t)}continueQuery(t){this.runningQueries.has(t)&&this.sendQuery([Ce.QueryType.CONTINUE],t)}async readNext(t){if(!this.isOpen)throw this.lastError||new $.RethinkDBError("The connection was closed before the query could be completed",{type:Q.RethinkDBErrorType.CONNECTION});if(!this.runningQueries.has(t))throw new $.RethinkDBError("No more rows in the cursor.",{type:Q.RethinkDBErrorType.CURSOR_END});let{data:r=null}=this.runningQueries.get(t)||{};if(!r)throw new $.RethinkDBError("Query is not running.",{type:Q.RethinkDBErrorType.CURSOR});let n=await r.dequeue();if((0,ei.isNativeError)(n))throw r.destroy(n),this.runningQueries.delete(t),n;return this.status==="handshake"?this.runningQueries.delete(t):n.t!==Ce.ResponseType.SUCCESS_PARTIAL&&(this.runningQueries.delete(t),this.emit("release",this.runningQueries.size)),n}close(t){for(let{data:r,query:n}of this.runningQueries.values())r.destroy(new $.RethinkDBError("The connection was closed before the query could be completed",{term:n[1],type:Q.RethinkDBErrorType.CONNECTION}));this.runningQueries.clear(),this.socket&&(this.socket.removeAllListeners(),this.socket.destroy(),this.socket=void 0,this.isOpen=!1,this.mode="handshake",this.emit("close",t),this.removeAllListeners(),this.nextToken=0)}async performHandshake(){if(!this.socket||this.status!=="handshake")throw new $.RethinkDBError("Connection is not open",{type:Q.RethinkDBErrorType.CONNECTION});let t=0,r=()=>{this.runningQueries.set(t,{data:new lr.DataQueue,query:[Ce.QueryType.START]}),t+=1},{randomString:n,authBuffer:i}=(0,ye.buildAuthBuffer)(this.user);r(),r(),this.socket.write(i),(0,ye.validateVersion)(await this.readNext(0));let{authentication:o}=await this.readNext(1),{serverSignature:a,proof:l}=await(0,ye.computeSaltedPassword)(o,n,this.user,this.password);r(),this.socket.write(l);let{authentication:u}=await this.readNext(2);(0,ye.compareDigest)(u,a),this.mode="response"}handleHandshakeData(){let t=-1;for(;(t=this.buffer.indexOf(0))>=0;){let r=this.buffer.subarray(0,t).toString("utf8"),{data:n=null}=this.runningQueries.get(this.nextToken++)||{},i;try{let o=JSON.parse(r);o.success?n&&n.enqueue(o):i=new $.RethinkDBError(o.error,{errorCode:o.error_code})}catch(o){i=new $.RethinkDBError(r,{cause:o,type:Q.RethinkDBErrorType.AUTH})}i&&(n&&n.destroy(i),this.handleError(i)),this.buffer=this.buffer.subarray(t+1),t=this.buffer.indexOf(0)}}handleData(){for(;this.buffer.length>=12;){let t=this.buffer.readUInt32LE(0)+4294967296*this.buffer.readUInt32LE(4),r=this.buffer.readUInt32LE(8);if(this.buffer.length<12+r)break;let n=this.buffer.subarray(12,12+r),i=JSON.parse(n.toString("utf8"));this.buffer=this.buffer.subarray(12+r);let{data:o=null}=this.runningQueries.get(t)||{};o&&o.enqueue(i)}}handleError(t){this.close(t),this.lastError=t,this.listenerCount("error")>0&&this.emit("error",t)}};le.RethinkDBSocket=Ct});var Ye=I(he=>{"use strict";var ti=he&&he.__rest||function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r};Object.defineProperty(he,"__esModule",{value:!0});he.RethinkDBConnection=void 0;var ri=require("events"),ce=m(),y=B(),hr=ie(),ni=_t(),ii=At(),yt=P(),fr=Ze(),si=G(),oi=[y.TermType.TABLE_CREATE,y.TermType.TABLE_DROP,y.TermType.TABLE_LIST,y.TermType.TABLE],Dt=class extends ri.EventEmitter{constructor(t,{db:r="test",user:n="admin",password:i="",timeout:o=20,pingInterval:a=-1,silent:l=!1,log:u=h=>{}}={}){super(),this.connectionOptions=t,this.db="test",this.options=(0,fr.setConnectionDefaults)(t),this.clientPort=this.options.port||28015,this.clientAddress=this.options.host||"localhost",this.timeout=o,this.pingInterval=a,this.silent=l,this.log=u,this.use(r),this.socket=new fr.RethinkDBSocket({connectionOptions:this.options,user:n,password:i})}eventNames(){return["release","close","timeout","error"]}get open(){return this.socket.status==="open"}get numOfQueries(){return this.socket.runningQueries.size}async close({noreplyWait:t=!1}={}){try{this.stopPinging(),t&&await this.noreplyWait(),await this.socket.close()}catch(r){throw await this.socket.close(),r}}async reconnect(t){(this.socket.status==="open"||this.socket.status==="handshake")&&await this.close(t),this.socket.on("connect",()=>this.emit("connect")).on("close",r=>{this.close(),this.emit("close",r)}).on("error",r=>{this.reportError(r)}).on("data",(r,n)=>this.emit(r,n)).on("release",r=>{r===0&&this.emit("release")});try{await Promise.race([(0,si.delay)(this.timeout*1e3,{unref:!0}),this.socket.connect()])}catch(r){let n=new ce.RethinkDBError("Unable to establish connection, see cause for more info.",{cause:r,type:yt.RethinkDBErrorType.CONNECTION});throw this.reportError(n),this.emit("close",n),this.close(),n}if(this.socket.status==="errored")throw this.reportError(this.socket.lastError),this.emit("close",this.socket.lastError),this.close(),this.socket.lastError;if(this.socket.status!=="open"){let r=new ce.RethinkDBError(`Failed to connect to ${this.clientAddress}:${this.clientPort} in less than ${this.timeout}s.`,{type:yt.RethinkDBErrorType.TIMEOUT});throw this.emit("timeout"),this.emit("close",r),this.close().catch(()=>{}),r}return this.startPinging(),this}use(t){this.db=t}async noreplyWait(){let t=this.socket.sendQuery([y.QueryType.NOREPLY_WAIT]);if((await this.socket.readNext(t)).t!==y.ResponseType.WAIT_COMPLETE){if(this.socket.status==="errored")throw this.socket.lastError;let n=new ce.RethinkDBError("Unexpected return value");throw this.reportError(n),n}}async server(){let t=this.socket.sendQuery([y.QueryType.SERVER_INFO]),r=await this.socket.readNext(t);if(r.t!==y.ResponseType.SERVER_INFO){if(this.socket.status==="errored")throw this.socket.lastError;let n=new ce.RethinkDBError("Unexpected return value");throw this.reportError(n),n}return r.r[0]}async query(t,r={}){let{timeFormat:n,groupFormat:i,binaryFormat:o}=r,a=ti(r,["timeFormat","groupFormat","binaryFormat"]);a.db=a.db||this.db,this.findTableTermAndAddDb(t,a.db),hr.globals.arrayLimit!==void 0&&a.arrayLimit===void 0&&(a.arrayLimit=hr.globals.arrayLimit);let l=[y.QueryType.START,t],u=(0,ni.parseOptarg)(a);u&&l.push(u);let h=this.socket.sendQuery(l);if(!r.noreply)return new ii.Cursor(this.socket,h,r,l)}findTableTermAndAddDb(t,r){if(!Array.isArray(t)){if(t!==null&&typeof t=="object"){Object.values(t).forEach(i=>this.findTableTermAndAddDb(i,r));return}return}let n=t[1];if(oi.includes(t[0])){if(!n){t[1]=[[y.TermType.DB,[r]]];return}let i=n[0];if(Array.isArray(i)&&i[0]===y.TermType.DB)return;n.unshift([y.TermType.DB,[r]]);return}n&&n.forEach(i=>this.findTableTermAndAddDb(i,r))}startPinging(){this.pingInterval>0&&(this.pingTimer=setTimeout(async()=>{try{if(this.socket.status==="open"){let t=this.socket.sendQuery([y.QueryType.START,[y.TermType.ERROR,["ping"]]]),r=await this.socket.readNext(t);(r.t!==y.ResponseType.RUNTIME_ERROR||r.e!==y.ErrorType.USER||r.r[0]!=="ping")&&this.reportError(new ce.RethinkDBError("Ping error",{responseType:r.t}))}}catch(t){this.reportError(t)}this.pingTimer&&this.startPinging()},this.pingInterval))}stopPinging(){this.pingTimer&&clearTimeout(this.pingTimer),this.pingTimer=void 0}reportError(t){this.listenerCount("error")>0&&this.emit("error",t),(!(0,ce.isRethinkDBError)(t)||t.type!==yt.RethinkDBErrorType.CANCEL)&&(this.log(t.toString()),this.silent||console.error(t.toString()))}};he.RethinkDBConnection=Dt});var Er=I(et=>{"use strict";Object.defineProperty(et,"__esModule",{value:!0});et.ServerConnectionPool=void 0;var ai=require("events"),vt=m(),Pt=P(),ui=Ye(),li=Ze(),ci=G(),mt=class extends ai.EventEmitter{constructor(t,{db:r="test",user:n="admin",password:i="",buffer:o=1,max:a=1,timeout:l=20,pingInterval:u=-1,timeoutError:h=1e3,timeoutGb:f=60*60*1e3,maxExponent:c=6,silent:E=!1,log:R=S=>{}}={}){super(),this.draining=!1,this.healthy=void 0,this.connections=[],this.timers=new Map,this.buffer=Math.max(o,1),this.max=Math.max(a,o),this.timeoutError=h,this.timeoutGb=f,this.maxExponent=c,this.silent=E,this.log=R,this.server=(0,li.setConnectionDefaults)(t),this.connParam={db:r,user:n,password:i,timeout:l,pingInterval:u,silent:E,log:R},this.connections=[]}eventNames(){return["draining","queueing","size","available-size","healthy","error"]}async initConnections(){this.connections.length<this.buffer&&!this.draining&&await this.createConnection().then(()=>this.initConnections())}get isHealthy(){return this.connections.some(t=>t.open)}waitForHealthy(){return new Promise((t,r)=>{this.isHealthy?t(this):this.once("healthy",(n,i)=>{n?t(this):r(new vt.RethinkDBError("Error initializing pool",{type:Pt.RethinkDBErrorType.POOL_FAIL,cause:i}))})})}async setOptions({buffer:t=this.buffer,max:r=this.max,silent:n=this.silent,log:i=this.log,timeoutError:o=this.timeoutError,timeoutGb:a=this.timeoutGb,maxExponent:l=this.maxExponent}){if(this.silent=n,this.log=i,this.timeoutError=o,this.timeoutGb=a,this.maxExponent=l,this.buffer<t&&this.connections.length<t?(this.buffer=t,await this.initConnections()):this.connections.forEach(u=>this.checkIdle(u)),this.max>r){let u=this.getIdleConnections();for(let h=0;h<this.max-r;h++){let f=u.pop();if(!f)break;await this.closeConnection(f)}}this.max=r}async drain(t=!0){t&&(this.emit("draining"),this.setHealthy(void 0)),this.draining=!0,await Promise.all(this.connections.map(r=>this.closeConnection(r)))}getConnections(){return this.connections}getLength(){return this.getOpenConnections().length}getAvailableLength(){return this.getIdleConnections().length}getNumOfRunningQueries(){return this.getOpenConnections().reduce((t,r)=>r.numOfQueries+t,0)}async queue(t,r={}){this.emit("queueing");let n=this.getOpenConnections();if(!n)throw this.reportError(new vt.RethinkDBError("No connections available",{type:Pt.RethinkDBErrorType.POOL_FAIL}),!0);let i=n.reduce((o,a)=>o.numOfQueries<=a.numOfQueries?o:a);return this.connections.length<this.max&&this.createConnection(),i.query(t,r)}setHealthy(t,r){t===void 0?this.healthy=void 0:t!==this.healthy&&t!==void 0&&(this.healthy=t,this.emit("healthy",t,r))}async createConnection(){let t=new ui.RethinkDBConnection(this.server,this.connParam);this.connections=[...this.connections,t],await this.persistConnection(t)}subscribeToConnection(t){if(t.open&&!this.draining){let r=this.getOpenConnections().length;this.emit("size",r),this.setHealthy(!0),this.checkIdle(t),t.on("close",n=>{let i=this.getOpenConnections().length;this.emit("size",i),i===0&&this.setHealthy(!1,n),t.removeAllListeners(),this.persistConnection(t)}).on("data",()=>this.checkIdle(t)).on("query",()=>this.checkIdle(t))}}async closeConnection(t){this.removeIdleTimer(t),t.removeAllListeners(),this.connections=this.connections.filter(r=>r!==t),await t.close(),this.emit("size",this.getOpenConnections().length)}checkIdle(t){this.removeIdleTimer(t),t.numOfQueries||(this.emit("available-size",this.getIdleConnections().length),this.timers.set(t,setTimeout(()=>{this.timers.delete(t),this.connections.length>this.buffer&&this.closeConnection(t).then(()=>this.emit("available-size",this.getIdleConnections().length))},this.timeoutGb)))}removeIdleTimer(t){let r=this.timers.get(t);r&&clearTimeout(r),this.timers.delete(t)}async persistConnection(t){let r=0;for(;this.connections.includes(t)&&!t.open&&!this.draining;)try{await t.reconnect()}catch(n){if(this.reportError(n),this.connections.length>this.buffer){this.closeConnection(t);break}this.healthy===void 0&&this.setHealthy(!1,n),await(0,ci.delay)(2**r*this.timeoutError),r=Math.min(r+1,this.maxExponent)}if(!this.connections.includes(t)||this.draining){await this.closeConnection(t);return}this.subscribeToConnection(t)}reportError(t,r=!1){return this.listenerCount("error")>0&&this.emit("error",t),r&&(!(0,vt.isRethinkDBError)(t)||t.type!==Pt.RethinkDBErrorType.CANCEL)&&(this.log(t.toString()),this.silent||console.error(t.toString())),t}getOpenConnections(){return this.connections.filter(t=>t.open)}getIdleConnections(){return this.getOpenConnections().filter(t=>!t.numOfQueries)}};et.ServerConnectionPool=mt});var Or=I(fe=>{"use strict";var hi=fe&&fe.__rest||function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r};Object.defineProperty(fe,"__esModule",{value:!0});fe.MasterConnectionPool=void 0;var fi=require("events"),dr=require("net"),_r=m(),Ei=Ge(),Rr=P(),di=Er(),_i=Ze(),Ri=G();function Oi(e,t){return[...e,...t]}function Ai(e){return e.map(t=>/^127(\.\d{1,3}){3}$/.test(t.host)||/0?:?0?:?0?:?0?:?0?:?0?:0?:1/.test(t.host)?{address:t,value:0}:(0,dr.isIPv6)(t.host)&&/^[fF]|[eE]80:.*:.*:/.test(t.host)?{address:t,value:1}:/^169\.254\.\d{1,3}\.\d{1,3}$/.test(t.host)?{address:t,value:2}:/^192\.168\.\d{1,3}\.\d{1,3}$/.test(t.host)?{address:t,value:3}:/^172\.(1\d|2\d|30|31)\.\d{1,3}\.\d{1,3}$/.test(t.host)?{address:t,value:4}:/^10(\.\d{1,3}){3}$/.test(t.host)?{address:t,value:5}:(0,dr.isIPv6)(t.host)&&/^[fF]|[cCdD].*:.*:/.test("address.host")?{address:t,value:6}:{address:t,value:7}).reduce((t,r)=>t.value>r.value?t:r).address.host}var wt=class extends fi.EventEmitter{constructor({db:t="test",user:r="admin",password:n="",discovery:i=!1,servers:o=[{host:"localhost",port:28015}],buffer:a=o.length,max:l=o.length,timeout:u=20,pingInterval:h=-1,timeoutError:f=1e3,timeoutGb:c=60*60*1e3,maxExponent:E=6,silent:R=!1,log:S=_=>{}}={}){super(),this.draining=!1,this.healthy=void 0,this.discovery=i,this.connParam={db:t,user:r,password:n,buffer:Math.max(a,1),max:Math.max(l,a),timeout:u,pingInterval:h,timeoutError:f,timeoutGb:c,maxExponent:E,silent:R,log:S},this.servers=o.map(_i.setConnectionDefaults),this.serverPools=[]}setOptions({discovery:t=this.discovery,buffer:r=this.connParam.buffer,max:n=this.connParam.max,timeoutError:i=this.connParam.timeoutError,timeoutGb:o=this.connParam.timeoutGb,maxExponent:a=this.connParam.maxExponent,silent:l=this.connParam.silent,log:u=this.connParam.log}){this.discovery!==t&&(this.discovery=t,t?this.discover():this.discoveryCursor&&this.discoveryCursor.close()),this.connParam=Object.assign(Object.assign({},this.connParam),{buffer:r,max:n,timeoutError:i,timeoutGb:o,maxExponent:a,silent:l,log:u}),this.setServerPoolsOptions(this.connParam)}eventNames(){return["draining","queueing","size","available-size","healthy","error"]}async initServers(t=0){if(t<this.servers.length)return this.createServerPool(this.servers[t]).then(r=>this.draining?r.drain():this.initServers(t+1));this.draining||this.setServerPoolsOptions(this.connParam)}get isHealthy(){return this.serverPools.some(t=>t.isHealthy)}waitForHealthy(){return new Promise((t,r)=>{this.isHealthy?t(this):this.once("healthy",(n,i)=>{n?t(this):r(new _r.RethinkDBError("Error initializing master pool",{type:Rr.RethinkDBErrorType.MASTER_POOL_FAIL,cause:i}))})})}async drain(){this.emit("draining"),this.draining=!0,this.discovery=!1,this.discoveryCursor&&this.discoveryCursor.close(),this.setHealthy(!1),await Promise.all(this.serverPools.map(t=>this.closeServerPool(t)))}getPools(){return this.serverPools}getConnections(){return this.serverPools.map(t=>t.getConnections()).reduce(Oi,[])}getLength(){return this.getOpenConnections().length}getAvailableLength(){return this.getIdleConnections().length}async queue(t,r={}){if(!this.isHealthy)throw new _r.RethinkDBError("None of the pools have an opened connection and failed to open a new one.",{type:Rr.RethinkDBErrorType.POOL_FAIL});return this.emit("queueing"),this.getPoolWithMinQueries().queue(t,r)}async createServerPool(t){let r=new di.ServerConnectionPool(t,Object.assign(Object.assign({},this.connParam),{buffer:1,max:1}));return this.serverPools.push(r),this.subscribeToPool(r),r.initConnections().catch(()=>{}),r.waitForHealthy()}setServerPoolsOptions(t){let{buffer:r=1,max:n=1}=t,i=hi(t,["buffer","max"]),o=this.getPools(),a=o.filter(l=>l.isHealthy).length;for(let l=0;l<o.length;l++){let u=o[l];u.setOptions(u.isHealthy?Object.assign(Object.assign({},i),{buffer:Math.floor(r/a)+(l===r%a-1?1:0),max:Math.floor(n/a)+(l===n%a-1?1:0)}):i).then(()=>{this.draining&&u.drain()})}this.draining&&o.forEach(l=>l.drain())}async discover(){this.discoveryCursor=await Ei.r.db("rethinkdb").table("server_status").changes({includeInitial:!0,includeStates:!0}).run();let t=[],r="initializing";return this.discoveryCursor.eachAsync(async n=>{if(n.state&&(r=n.state,n.state==="ready"&&this.servers.forEach(i=>{t.some(o=>o===i)||this.removeServer(i)})),n.new_val){let i=this.getServerFromStatus(n.new_val);r==="initializing"&&t.push(i),this.servers.includes(i)||(this.servers.push(i),this.createServerPool(i).then(()=>this.setServerPoolsOptions(this.connParam)))}else n.old_val&&this.removeServer(this.getServerFromStatus(n.old_val))}).catch(()=>(0,Ri.delay)(2e4)).then(()=>this.discovery?this.discover():void 0)}getServerFromStatus(t){return this.servers.find(n=>(n.host===t.network.hostname||!!t.network.canonical_addresses.find(i=>i.host===n.host))&&n.port===t.network.reql_port)||{host:Ai(t.network.canonical_addresses),port:t.network.reql_port}}async removeServer(t){this.servers.includes(t)&&(this.servers=this.servers.filter(n=>n!==t));let r=this.serverPools.find(n=>t.host===n.server.host&&t.port===n.server.port);r&&(await this.closeServerPool(r),this.setServerPoolsOptions(this.connParam))}subscribeToPool(t){let r=this.getOpenConnections().length;this.emit("size",r),r>0&&this.setHealthy(!0),t.on("size",()=>this.emit("size",this.getOpenConnections().length)).on("available-size",()=>this.emit("available-size",this.getAvailableLength())).on("error",n=>{this.listenerCount("error")>0&&this.emit("error",n)}).on("healthy",(n,i)=>{if(!n){let{server:o}=t;this.closeServerPool(t).then(()=>new Promise(a=>setTimeout(a,this.connParam.timeoutError||1e3))).then(()=>{this.draining||this.createServerPool(o).catch(()=>{})})}this.setHealthy(!!this.getHealthyServerPools().length,i)})}setHealthy(t,r){t===void 0?this.healthy=void 0:t!==this.healthy&&t!==void 0&&(this.healthy=t,this.emit("healthy",t,r))}async closeServerPool(t){if(t){t.removeAllListeners();let r=this.serverPools.indexOf(t);r>=0&&this.serverPools.splice(r,1),await t.drain()}}getHealthyServerPools(){return this.serverPools.filter(t=>t.isHealthy)}getPoolWithMinQueries(){return this.getHealthyServerPools().reduce((t,r)=>t.getNumOfRunningQueries()<r.getNumOfRunningQueries()?t:r)}getOpenConnections(){return this.getConnections().filter(t=>t.open)}getIdleConnections(){return this.getOpenConnections().filter(t=>!t.numOfQueries)}};fe.MasterConnectionPool=wt});var Ar=I(rt=>{"use strict";Object.defineProperty(rt,"__esModule",{value:!0});rt.validateTerm=void 0;var X=m(),Ii=B();function tt(e){if(e===void 0)throw new X.RethinkDBError(`Invalid term:
${JSON.stringify(e)}
`);if(typeof e=="function")throw new X.RethinkDBError(`Invalid term:
${e.toString()}
`);if(typeof e=="object"){if(Array.isArray(e)){if(e.length>3)throw new X.RethinkDBError(`Invalid term:
${JSON.stringify(e)}
`);let[t,r,n]=e;if(typeof t!="number"||Ii.TermType[t]===void 0)throw new X.RethinkDBError(`Invalid term:
${JSON.stringify(e)}
`);if(r!==void 0){if(!Array.isArray(r))throw new X.RethinkDBError(`Invalid term:
${JSON.stringify(e)}
`);if(!r.every(i=>tt(i)))throw new X.RethinkDBError(`Invalid term:
${JSON.stringify(e)}
`)}if(n!==void 0&&!Object.values(e).every(i=>tt(i)))throw new X.RethinkDBError(`Invalid term:
${JSON.stringify(e)}
`)}else if(!Object.values(e).every(t=>tt(t)))throw new X.RethinkDBError(`Invalid term:
${JSON.stringify(e)}
`)}return e}rt.validateTerm=tt});var Ge=I(A=>{"use strict";Object.defineProperty(A,"__esModule",{value:!0});A.r=void 0;var Si=Ye(),pi=Or(),Ee=m(),de=P(),bt=ie(),nt=we(),it=ke(),_e=Rt(),gi=Ar(),Ni=Me(),Ir=(e,t=bt.globals.nestingLevel)=>(0,it.isQuery)(e)?e:(0,_e.toQuery)((0,Ni.parseParam)(e,t));A.r=Ir;A.r.connectPool=async(e={})=>{let{host:t,port:r,server:n={host:t,port:r},servers:i=[n],waitForHealthy:o=!0}=e;if(t||r){if(e.server)throw new Ee.RethinkDBError("If `host` or `port` are defined `server` must not be.",{type:de.RethinkDBErrorType.API_FAIL});if(e.servers)throw new Ee.RethinkDBError("If `host` or `port` are defined `servers` must not be.",{type:de.RethinkDBErrorType.API_FAIL})}if(e.server&&e.servers)throw new Ee.RethinkDBError("If `server` is defined `servers` must not be.",{type:de.RethinkDBErrorType.API_FAIL});if(!i.length)throw new Ee.RethinkDBError("If `servers` is an array, it must contain at least one server.",{type:de.RethinkDBErrorType.API_FAIL});A.r.pool&&(A.r.pool.removeAllListeners(),A.r.pool.drain());let a=new pi.MasterConnectionPool(Object.assign(Object.assign({},e),{servers:i}));return A.r.pool=a,a.initServers().catch(()=>{}),o?a.waitForHealthy():a};A.r.connect=async(e={})=>{let{host:t,port:r,server:n={host:t,port:r}}=e;if((t||r)&&e.server)throw new Ee.RethinkDBError("If `host` or `port` are defined `server` must not be.",{type:de.RethinkDBErrorType.API_FAIL});let i=new Si.RethinkDBConnection(n,e);return await i.reconnect(),i};A.r.getPoolMaster=()=>A.r.pool;A.r.waitForHealthy=()=>{if(A.r.pool)return A.r.pool.waitForHealthy();throw new Ee.RethinkDBError("Pool not initialized",{type:de.RethinkDBErrorType.MASTER_POOL_FAIL})};A.r.setNestingLevel=e=>{bt.globals.nestingLevel=e};A.r.setArrayLimit=e=>{bt.globals.arrayLimit=e};A.r.serialize=e=>JSON.stringify(e.term);A.r.deserialize=e=>(0,_e.toQuery)((0,gi.validateTerm)(JSON.parse(e)));A.r.expr=Ir;A.r.do=(...e)=>{let t=e.pop();return(0,it.termBuilder)(nt.funcall,_e.toQuery)(t,...e)};nt.rConfig.forEach(e=>A.r[e[1]]=(0,it.termBuilder)(e,_e.toQuery));nt.rConsts.forEach(([e,t])=>A.r[t]=(0,_e.toQuery)([e]));nt.termConfig.filter(([e,t])=>!(t in A.r)).forEach(([e,t,r,n,i])=>A.r[t]=(0,it.termBuilder)([e,t,r+1,n===-1?n:n+1,i],_e.toQuery))});var Lt=I(L=>{"use strict";var Ci=L&&L.__createBinding||(Object.create?function(e,t,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(t,r);(!i||("get"in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,i)}:function(e,t,r,n){n===void 0&&(n=r),e[n]=t[r]}),yi=L&&L.__exportStar||function(e,t){for(var r in e)r!=="default"&&!Object.prototype.hasOwnProperty.call(t,r)&&Ci(t,e,r)};Object.defineProperty(L,"__esModule",{value:!0});L.isCursor=L.isRethinkDBError=L.r=void 0;var Di=Ge();Object.defineProperty(L,"r",{enumerable:!0,get:function(){return Di.r}});yi(P(),L);var vi=m();Object.defineProperty(L,"isRethinkDBError",{enumerable:!0,get:function(){return vi.isRethinkDBError}});var Pi=At();Object.defineProperty(L,"isCursor",{enumerable:!0,get:function(){return Pi.isCursor}})});function Mt(e){return Object.getOwnPropertyNames(e).reduce((r,n)=>(r[n]=e[n],r),{name:e.name})}var Ft=Z(require("crypto")),br=50,qt=e=>{let t=Ft.default.randomBytes(br).toString("hex").substring(0,e.length);return e.prefix?`${e.prefix}${t}`:t};var ve=class{constructor(){this.data={}}Value(t){return this.data[t]}SetValue(t,r){return this.data[t]=r}GetAll(){return this.data}};function ne(){return new ve}function xt(e){if(e===void 0||e.GetAll===void 0)return ne();let t=ne(),r=e.GetAll();for(let n of Object.keys(r))t.SetValue(n,e.Value(n));return t}function at(e,t,r){let n=xt(e);return n.SetValue(t,r),n}function Lr(e){return at(e,"request_id",qt({length:20,prefix:"REQ"}))}function Tr(e,t){return at(e,"client_id",t)}var $t={Background:ne,Extend:xt,WithClientID:Tr,WithRequestID:Lr,WithValue:at};var J=$t;function Yt(e,t){let n={...e!==void 0&&e.GetAll!==void 0?e.GetAll():{}};t.data&&(n={...n,...t.data});let i="\u2705";switch(t.level){case"critical":i="\u{1F525}";break;case"info":i="\u2705";break;case"error":i="\u{1F6D1}";break;case"warning":i="\u{1F7E1}";break}let o="";for(let a of Object.keys(n)){if(a==="error"&&n[a]&&n[a].message){o+=`${a}: ${n[a].message}
`;continue}if(typeof n[a]=="object"){o+=`${a}: ${JSON.stringify(n[a])}
`;continue}o+=`${a}: ${n[a]}
`}return`-----------
Log level ${t.level} ${i}
Event \u{1F504}: ${t.event}
Date: ${t.time}


${o}-------------
`}var ee=class{log(t,r){console.log(Yt(t,r))}},fs=new ee;var Br=new ee;function Gt(e,t){(!e||!e.Value)&&(e=ne()),t.time||(t.time=new Date),Br.log(e,t)}function Qt(e,t,r){return Gt(e,{event:t,data:Mt(r),level:"critical"})}function jt(e,t,r){return Gt(e,{event:t,data:r,level:"info"})}var Re=Z(Ie()),Nr=Z(Lt());var pr=Z(Ie());var st=Z(Ie());var Tt=class extends Error{constructor(t,r){super(t),this.name=r}};function Sr(e){let t=Number(e);return t!==t?(0,st.err)(new Tt("can not parse the given value","ParseError")):(0,st.ok)(t)}function mi(e,t="localhost"){let r=process.env[e];return r||t}function wi(e,t){let r=process.env[e];return r?Sr(r):(0,pr.ok)(t)}var bi={string:mi,number:wi},gr=bi;var Bt=gr;var Li=28015,ot;async function Ti(e){if(ot)return(0,Re.ok)(ot);let t=Bt.number("RETHINK_DB_PORT",Li);if(t.isErr())return(0,Re.err)(t.error);try{return ot=await Nr.r.connect({host:Bt.string("RETHINK_DB_HOST"),port:t.value}),(0,Re.ok)(ot)}catch(r){return(0,Re.err)(r)}}var Bi={getConnection:Ti},Ut=Bi;var Oe=Z(Lt());var v=Z(Ie());var Ui=new ee,Ae=Ui.log,j="rappi-demo",ki=["messages"];async function Mi(e,t,r){let n=Oe.r.db(j);if((await n.tableList().run(r)).includes(t))return Ae(e,{level:"info",event:"rethinkdb.setup",data:{message:`Table ${t} already exists`}}),(0,v.ok)(void 0);try{return Ae(e,{level:"info",event:"rethinkdb.setup",data:{message:`Creating table ${t}`}}),await n.tableCreate(t,{primaryKey:"id"}).run(r),(0,v.ok)(void 0)}catch(o){return(0,v.err)(o)}}async function Fi(e,t,r){for(let n of t){let i=await Mi(e,n,r);if(i.isErr())return(0,v.err)(i.error)}return(0,v.ok)(void 0)}async function qi(e){let t=await Ut.getConnection(e);if(t.isErr())return(0,v.err)(t.error);if(await Oe.r.dbList().contains(j).run(t.value))Ae(e,{level:"info",event:"rethinkdb.setup",data:{message:`Database ${j} already exists`}});else try{Ae(e,{level:"info",event:"rethinkdb.setup",data:{message:`Creating database ${j}`}}),await Oe.r.dbCreate(j).run(t.value)}catch(i){return(0,v.err)(i)}let n=await Fi(e,ki,t.value);return n.isErr()?(0,v.err)(n.error):(0,v.ok)(void 0)}async function xi(){let e=await Ut.getConnection(J.Background());if(e.isErr())return(0,v.err)(e.error);if(!await Oe.r.dbList().contains(j).run(e.value))return Ae(J.Background(),{level:"info",event:"rethinkdb.setup",data:{message:`Database ${j} does not exist`}}),(0,v.ok)(void 0);try{Ae(J.Background(),{level:"info",event:"rethinkdb.setup",data:{message:`Deleting database ${j}`}}),await Oe.r.dbDrop(j).run(e.value)}catch(r){return(0,v.err)(r)}return(0,v.ok)(void 0)}var $i={setup:qi,setDown:xi},Cr=$i;async function Hi(){let e=await Cr.setup(J.Background());e.isErr()&&Qt(J.Background(),"setup",e.error),jt(J.Background(),"setup",{message:"Setup complete"})}Hi();
